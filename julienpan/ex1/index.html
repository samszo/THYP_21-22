<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Humanité numérique 2021-2022</title>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /*pour les initiales en majuscule*/
        .card-title:first-letter {
            text-transform: uppercase;
        }

        .title {
            font-size: 40px;
            display: initial;
        }

        img {
            width: 100%;
            height: 100%;
            max-width: 200px;
            max-height: 200px;
        }

        .container {
            display: flex;
        }
    </style>
</head>

<body>
    <title class="title">Humanité numérique 2021 - 2022</title>


    <div class="container">
        <div class="row" id="etuGraph">
            
        </div>
        <svg width="600" height="500"></svg>
    </div>

    <script>

        //
        var dataPhoto, dataForm, dataFacet = [], dataDoublons = {}
            , vals = {
                "Pas besoin": 1, "Besoin d'approfondissement": 5, "Besoin urgent": 10, "je ne connais pas du tout": 1, "je connais un peu": 5, "je vonnais bien": 10, "je suis expert(e)": 20
                , "Oui": 1, "Non": 1
                , "jamais": 1, "rarement": 2, "souvent": 5, "je suis accro": 10
                , "Dans quel parcours êtes vous inscris ?": "Parcours"
                , "Avez-vous un ordinateur personnel pour suivre les cours ?": "Ordinateur"
                , "Votre connexion internet personnelle est :": "Connexion"
                , "Votre compte GitHub": "Compte"
                , "Votre compte Diigo": "Compte"
                , "Votre compte Zotero": "Compte"
                , "Vos spécialités": "Spécialités"
                , "Vos spécialités": "Objectifs"
                , "Votre formation précédente": "Formation"
                , "Quelles sont besoins ?": "Besoins"
                , "Quelles sont vos compétences ?": "Compétences"
                , "Quelles outils utilisez vous ?": "Outils"
                , "Langages": "Langages"
                , "Langues": "Langues"
                , "CMS": "CMS"
                , "Quels réseaux sociaux": "Réseaux sociaux"
            }
            , selectEtu;


        //récupération des données des formulaires google
        //"FormulaireGEN19.csv";//
        let url = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTM42Rbon532i3N3aW25ZpkoKtsMN-u6C7ycSj6A3DP2QCO89n3OMkseL--aI9a9s3ouwQJsVk6cOFw/pub?gid=513110937&single=true&output=csv';
        //let url = 'data.csv';            
        var q = d3.queue()
            .defer(d3.csv, url)
            .awaitAll(function (error, results) {
                if (error) throw error;
                setData(results);
            });

        var divTT = d3.select("body").append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);

        function setData(data) {

            dataForm = data[0];
            let dataEtu = [];

            dataForm.forEach(function (d, j) {
                d.reponses = { 'besoins': [], 'competences': [], 'outils': [] };
                for (let i in d) {

                    let quest = i.indexOf("[") > 0 ? vals[i.substring(0, i.indexOf("[") - 1)] : vals[i];
                    let prop = i.substring(i.indexOf("[") + 1, i.indexOf("]"));
                    let v = d[i];
                    let n = vals[v];
                    if (quest) {
                        if (dataDoublons[quest] === undefined) {
                            dataDoublons[quest] = dataFacet.length;
                            dataFacet.push({ 'label': quest, 'values': [] });
                        }
                        let rep = prop ? prop : v;
                        let kRep = quest + '_' + rep;
                        if (dataDoublons[kRep] === undefined) {
                            dataDoublons[kRep] = dataFacet[dataDoublons[quest]]['values'].length;
                            dataFacet[dataDoublons[quest]]['values'].push({
                                'prop': rep
                                , 'importance': 0
                                , 'expression': v
                                , 'ids': []
                            });
                        }
                        dataFacet[dataDoublons[quest]]['values'][dataDoublons[kRep]]['ids'].push(j);
                        dataFacet[dataDoublons[quest]]['values'][dataDoublons[kRep]]['importance'] += n ? n : 1;

                    }
                    if (i.indexOf("besoins") > 0) {
                        d.reponses.besoins.push({ 'prop': prop, 'importance': n, 'expression': v, 'id': j });
                    }
                    if (i.indexOf("compétences") > 0) {
                        d.reponses.competences.push({ 'prop': prop, 'importance': n, 'expression': v, 'id': j });
                    }
                    if (i.indexOf("outils utilisez") > 0) {
                        d.reponses.outils.push({ 'prop': prop, 'importance': n, 'expression': v, 'id': j });
                    }
                }
            });


            var cards = d3.select('#etuGraph').selectAll(".col-sm-4 mb-12").data(dataForm).enter()
                .append('div').attr('class', 'col-sm-4 mb-12').style('margin-bottom', '10px')
                .append("div").attr('class', 'card');
            cards.append("img")
                .attr('id', function (d, i) { return 'imgCard' + i })
                .attr('class', 'card-img-top')
                .attr('src', function (d) {
                    let url = new URL(d['Votre photo']);
                    let urlParam = new URLSearchParams(url.search);
                    let id = urlParam.get('id');
                    let urlTof = "https://drive.google.com/uc?id=" + id + "&export=download";
                    return urlTof;
                });


    
            var cardBody = cards.append('div').attr('class', 'card-body');
            cardBody.append('h4').attr('class', 'card-title')
                .text(function (d) {
                    return d['Votre prénom'].toLowerCase();
                });
            cardBody.append('h5').attr('class', 'card-title')
                .text(function (d) {
                    return d['Votre nom'].toLowerCase();
                });
            cardBody.append('h6').text(d => d['Dans quel parcours êtes vous inscris ?']);


            html = '<div class="container"><div class="row">';
            html += '<div id="etudNum__Col1" class="col-sm" style="padding-right:0px;padding-left:0px;"></div>';
            html += '<div id="etudNum__Col2" class="col-sm" style="padding-right:0px;padding-left:0px;"></div>';
            html += '<div id="etudNum__Col3" class="col-sm" style="padding-right:0px;padding-left:0px;"></div>';
            html += '</div></div>';
            cardBody.append('div').attr('class', 'card-text').attr('id', function (d, i) { return 'etudNum_' + i; })
                .html(function (d, i) { return html.replace(/__/gi, "_" + i + "_"); });
            cards.append('div').attr('class', 'card-footer')
                .append('small').attr('class', 'text-muted')
                .text(function (d, i) {

                    var size = 200;
                    drawGraphResponse("#etudNum_" + i + "_Col1", 'Besoins', d.reponses.besoins, size);
                    drawGraphResponse("#etudNum_" + i + "_Col2", 'Compétences', d.reponses.competences, size);
                    drawGraphResponse("#etudNum_" + i + "_Col3", 'Outils', d.reponses.outils, size);
                    return d['Votre mail'].toLowerCase();
                });

        }

        function drawGraphResponse(idE, titre, data, size) {

            let etuGraph = etuChart()
                .width(size)
                .height(size)
                .cornerRadius(0)
                .padAngle(0)
                .variable('importance')
                .category('prop')
                .title(titre);
            let s = d3.select(idE)
                .datum(data)
                .call(etuGraph);
            console.log(idE + " graph fait");
        }

        function etuChart() {
            var width,
                height,
                margin = { top: 0, right: 0, bottom: 10, left: 0 },
                colour = d3.scaleOrdinal(d3.schemeCategory20c),
                variable,
                category,
                padAngle,
                floatFormat = d3.format('.4r'),
                cornerRadius,
                percentFormat = d3.format(',.2%'),
                title;

            function chart(selection) {
                selection.each(function (data) {


                    // var radius = Math.min(width, height) / 2;

                    // // var pie = d3.pie().value(function (d) {
                    // //     return floatFormat(d[variable]);
                    // // })
                    // //     .sort(null);

                    // var pie = d3.pie();

                    // var arc = d3.arc()
                    //     .innerRadius(0)
                    //     .outerRadius(radius);

                    // var arcs = g.selectAll("arc")
                    //     .data(pie(data))
                    //     .enter()
                    //     .append("g")
                    //     .attr("class", "arc")

                    // var arc = d3.arc()
                    //     .outerRadius(radius)
                    //     .innerRadius(radius)
                    //     .cornerRadius(cornerRadius)
                    //     .padAngle(padAngle);

                    // this arc is used for aligning the text labels
                    // var outerArc = d3.arc()
                    //     .outerRadius(radius)
                    //     .innerRadius(radius);

                    var radius = Math.min(width, height) / 2;

                
                        var pie = d3.pie()
                            .value(function (d) { return floatFormat(d[variable]); })
                            .sort(null);



                        var arc = d3.arc()
                            .outerRadius(radius * 0.8)
                            .innerRadius(radius * 0.6)
                            .cornerRadius(cornerRadius)
                            .padAngle(padAngle);

                        var outerArc = d3.arc()
                            .outerRadius(radius * 0.9)
                            .innerRadius(radius * 0.9);


                    var wSvg = width + margin.left + margin.right, hSvg = height + margin.top + margin.bottom;
                    var svg = selection.append('svg')
                        .attr('width', wSvg)
                        .attr('height', hSvg)
                        .append('g')
                        .attr('transform', 'translate(' + wSvg / 2 + ',' + hSvg / 2 + ')');
                    // ===========================================================================================

                    svg.append('g').attr('class', 'slices');
                    svg.append('g').attr('class', 'labelName');
                    svg.append('g').attr('class', 'lines');

                    var path = svg.select('.slices')
                        .datum(data).selectAll('path')
                        .data(pie)
                        .enter().append('path')
                        .attr('fill', function (d) {
                            d.couleur = colour(d.data[category])
                            return d.couleur;
                        })
                        .attr('d', arc);

                    svg.append('text')
                        .html(title)
                        .attr('text-anchor', 'middle')
                        .attr('y', hSvg / 2);
                });

                // d3.csv("data.csv", function (error, data) {
                    //     if (error) {
                    //         throw error;
                    //     }

                    //     xScale.domain(data.map(function (d) { return d.year; }));
                    //     yScale.domain([0, d3.max(data, function (d) { return d.value; })]);

                    //     g.append("g")
                    //         .attr("transform", "translate(0," + height + ")")
                    //         .call(d3.axisBottom(xScale));

                    //     g.append("g")
                    //         .call(d3.axisLeft(yScale).tickFormat(function (d) {
                    //             return "$" + d;
                    //         }).ticks(10))
                    //         .append("text")
                    //         .attr("y", 6)
                    //         .attr("dy", "0.71em")
                    //         .attr("text-anchor", "end")
                    //         .text("value");
                    // })
            }

            chart.width = function (value) {
                if (!arguments.length) return width;
                width = value;
                return chart;
            };

            chart.height = function (value) {
                if (!arguments.length) return height;
                height = value;
                return chart;
            };

            chart.margin = function (value) {
                if (!arguments.length) return margin;
                margin = value;
                return chart;
            };

            chart.radius = function (value) {
                if (!arguments.length) return radius;
                radius = value;
                return chart;
            };

            chart.padAngle = function (value) {
                if (!arguments.length) return padAngle;
                padAngle = value;
                return chart;
            };

            chart.cornerRadius = function (value) {
                if (!arguments.length) return cornerRadius;
                cornerRadius = value;
                return chart;
            };

            chart.colour = function (value) {
                if (!arguments.length) return colour;
                colour = value;
                return chart;
            };

            chart.variable = function (value) {
                if (!arguments.length) return variable;
                variable = value;
                return chart;
            };

            chart.category = function (value) {
                if (!arguments.length) return category;
                category = value;
                return chart;
            };

            chart.title = function (value) {
                if (!arguments.length) return title;
                title = value;
                return chart;
            };

            return chart;

        }



    </script>

</body>

</html>
